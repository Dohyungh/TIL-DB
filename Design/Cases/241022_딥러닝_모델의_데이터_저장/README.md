# 딥러닝 모델의 데이터 저장과 관련한 DB 선택

- SSAFY 자율 프로젝트 `<SCV>` 중 발생한 고민을 문서화 하였다.
- `<SCV>`는 딥러닝 학습 플랫폼이다.
- 가벼운 Computer Vision 모델을 블록으로 구현하고 이를 파이썬 코드로 변환해 학습과 테스트를 거쳐 사용자에게 보여준다.

## 요구사항

- 모델의 메타데이터 (작성자, 수정날짜 등)를 저장한다.
- 모델의 각 layer에 대한 정보 (레이어 이름, 파라미터 종류와 값) 를 저장한다.
- **모델의 CRUD가 빈번하다.**
- 학습된 모델의 가중치 데이터는 기본적으로 저장하지 않는다.
- 그러나, 모델이 학습된 직후에 사용자가 임의로 제출한 1개의 데이터에 대해서는 추론을 허용한다.

### AI 관련 기능 목록

- 유사도 기반 모델 추천과 분석 (요청할 때마다 새로운 모델 Pool에 대해 다시 실행)

  - VectorDB
    - FAISS : 파이썬 내부
    - Annoy : 파이썬 내부
    - **Milvus : 독립적인 컨테이너화 가능, 다른 컨테이너 접근 용이** `채택`

- 모델 정적 분석 (학습 시에 최초 한번만 실행)
  - 정량 지표 (파라미터 개수)
  - 정성 지표 (시각화)
  - **mongoDB : NoSQL 진영으로 분리해 사용** `채택`
  - Postgresql (JSONB 타입 지원)

## 구상

- 다음의 모델을 저장하고 싶다 했을 때

  ![alt text](./assets/image-2.png)

### JSON 방식

![alt text](./assets/image.png)

- RDBMS에는 JSON 파일의 이름을 저장 (ULID, 시간순 정렬 가능하게)
  - Postgresql 같은 경우 JSONB 타입을 지원하기 때문에 파일로 따로 저장할 필요도 없다.

### DB 방식

![alt text](./assets/image-1.png)

- 각 layer를 tuple로 만들고, layer의 위치정보를 layer_ID로 저장

#### 문제점

- Join이 너무 많이 필요함
- 모델의 CRUD가 빈번한데 각 행마다 조회해서 Update하기가 어려움

## 결론

![alt text](./assets/image-3.png)

- 모델의 layer 구성은 JSON 형식으로 MongoDB에 저장한다.
- 모델의 Metadata는 RDBMS에 저장한다.

이렇게 함으로써 화면에 모델 목록을 뿌려줄 떄는 RDBMS에서 메타데이터로만 Body를 구성해 응답해주고, 사용자가 모델 개발 화면에 들어갔을 때 MongoDB에 `모델_ID + 버전_ID`를 키로 모델의 구조를 받아서 응답한다.

즉,

- REST API 호출 타이밍에 필요한 데이터가 무엇인지에 집중하였다.
- JSON 타입이 필요한 데이터에 대해서만 MongoDB에 저장하였다.

## (10.23 추가) SSAFY 컨설턴트 상담 내용

### 요약

- JSON 형태의 데이터를 MongoDB에 저장한다고 했을 때, 해당 JSON 데이터 중에 개별적으로 뽑아내서 사용할 일이 있는 것들은 RDBMS에 옮기는 것이 좋을 것 같다.
  - 예를 들어, 어떤 데이터셋에 대해 학습한 결과인지 (ex. MNIST, Fashion-MNIST) 는,
  - 나중에 데이터셋에 따라 필터링 할 니즈가 생길 수 있다.
  - 따라서 해당 feature는 RDBMS에 "도" 저장하거나, 따로 빼는 것이 좋을 것 같다.

> 본 상담 내용은, 데이터 분석가의 "로그 남겨놓기"에 대한 니즈와도 맞닿는 부분이 있는 것 같다. 우리 사이트를 이용하는 사람들의 통계를 내고 싶을 때, 데이터 셋 별로 얼마나 많은 사람들이 선택했는지 보고 싶을 수 있다. 그런데, 해당 Feature가 JSON 의 한 필드로 묶여서 MongoDB에 저장되고 있다면, 매번 해당 JSON을 열어봐야 하기 때문에 비효율적이고, 심한 경우 로그를 남기기 위해 레거시 프로젝트를 심하게 훼손해야 할 수 도 있을 것이다.

- JSON 형태의 데이터, MongoDB가 아니더라도 MySQL이나 Postgresql의 JSON 타입을 사용하는 것을 추천한다.
  - 데이터의 크기가 16MB 보다 크지 않다면, 나쁘지 않은 선택이다.
  - ~~정 MongoDB가 써보고 싶다면 말리지 않겠다.~~

> 본 상담 내용을 듣고 많은 고민이 되었다. 1. MongoDB에 JSON 형태의 데이터를 저장하는 것(BSON)과 2. RDBMS에 JSON 타입으로 저장하는 것. 둘 중에서 어떤 것이 좋은지, 혹은 맞는지, 혹은 어떤 상황에 어느 것을 쓰는 게 맞는지, 가 잘 가늠이 되지 않는다. 결국 팀원들과의 회의 결과 추천하신대로 RDBMS에 JSON 타입으로 저장하는 것으로 결론을 지었다. 모델의 layer 정보에 대한 양이 그리 많지 않아 용량면에서 걸릴 것이 없을 것이라는 이유에서였다. (납득은 잘 안된다.)
